<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Seguimiento Serpost (antiguo)</title>
    <link rel="shortcut icon" href="favicon.ico" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.7.4/css/bulma.min.css"
    />
    <style>
      html {
        overflow-y: auto;
      }
      table {
        margin: 0 auto;
      }
      .table th {
        vertical-align: middle;
      }
    </style>
  </head>
  <body>
    <section class="section" id="main">
      <div class="container has-text-centered">
        <h1 class="title">Serpost</h1>
        <h2 class="subtitle">Seguimiento (antiguo)</h2>
        <form class="field has-addons has-addons-centered">
          <div class="control">
            <input
              required
              type="text"
              maxlength="13"
              class="input has-text-centered"
              placeholder="Nùmero de seguimiento"
              pattern="^[CARVEL][A-Z]\d{9}[A-Z]{2}$"
            />
          </div>
          <div class="control">
            <button class="button is-success">Buscar</button>
          </div>
        </form>
      </div>
    </section>
    <section class="section is-hidden" id="info">
      <div class="container has-text-centered">
        <h1 class="title">Serpost</h1>
        <h2 class="subtitle">Detalle seguimiento (antiguo)</h2>
        <div class="table-container">
          <table class="table is-narrow is-bordered is-hoverable">
            <tbody>
              <tr>
                <th rowspan="4">ENVÍO</th>
                <th>NÚMERO</th>
                <td data-prop="ENVIO"></td>
              </tr>
              <tr>
                <th>ORIGEN</th>
                <td data-prop="OFICINAORIGEN"></td>
              </tr>
              <tr>
                <th>DESTINO</th>
                <td data-prop="OFICINADESTINO"></td>
              </tr>
              <tr>
                <th>ESTADO</th>
                <td data-prop="ESTADO" data-defv="EN PROCESO"></td>
              </tr>
              <tr>
                <th rowspan="4">ENTREGA</th>
                <th>FECHA</th>
                <td data-prop="FECHAENTREGA"></td>
              </tr>
              <tr>
                <th>DESTINATARIO</th>
                <td data-prop="DESTINATARIO"></td>
              </tr>
              <tr>
                <th>DOCUMENTO</th>
                <td data-prop="DOCUMENTO"></td>
              </tr>
              <tr>
                <th>FECHA ADUANA</th>
                <td>--- TBD ---</td>
              </tr>
            </tbody>
            <tfoot></tfoot>
          </table>
        </div>
        <button class="button is-info" id="back">VOLVER</button>
      </div>
    </section>
    <script>
      ;(function(document) {
        function toggleLoad() {
          var show = document.querySelector('button')
          show.disabled = !show.disabled
          show.classList.toggle('is-loading')
        }
        function togglePage() {
          document.getElementById('main').classList.toggle('is-hidden')
          document.getElementById('info').classList.toggle('is-hidden')
        }
        function feedTable(data) {
          var tds = document.querySelectorAll('[data-prop]')
          for (var i = 0, l = tds.length; i < l; i++) {
            var ds = tds[i].dataset
            tds[i].innerText = data[ds.prop] || ds.defv || '-'
          }
          var tfoot = document.querySelector('tfoot')
          while (tfoot.firstChild) tfoot.removeChild(tfoot.firstChild)
          if (data.ITEMS && data.ITEMS.ItemDetalle) {
            var first = true
            data.ITEMS.ItemDetalle.reverse().forEach(function(item) {
              var tr = document.createElement('tr')
              if (first) {
                first = false
                var th = document.createElement('th')
                th.innerText = 'HISTORIAL'
                th.rowSpan = data.ITEMS.ItemDetalle.length
                tr.appendChild(th)
              }
              var td = document.createElement('td')
              td.innerText = item.FECHAHORA
              tr.appendChild(td)
              td = document.createElement('td')
              td.innerText = item.DESCRIPCION
              tr.appendChild(td)
              tfoot.appendChild(tr)
            })
          }
        }
        function feedError(error) {
          // TODO: Better error handling
          alert('ERROR: ' + error.message)
        }

        var form = document.querySelector('form')
        var code = document.querySelector('input')
        form.onsubmit = function(e) {
          e.preventDefault()
          toggleLoad()

          var xhr = new XMLHttpRequest()
          xhr.onload = function() {
            var res = xhr.response
            if (res.data) {
              code.value = ''
              feedTable(res.data)
            } else {
              feedError(res.error)
            }
            toggleLoad()
            togglePage()
          }
          xhr.onerror = xhr.onabort = function() {
            feedError(new Error('Error desconocido, intente nuevamente.'))
            toggleLoad()
          }
          // TODO: Validate tracking number
          xhr.open('GET', '/api?track=' + code.value)
          xhr.responseType = 'json'
          xhr.send()
        }

        document.getElementById('back').onclick = togglePage
      })(document)
    </script>
  </body>
</html>
